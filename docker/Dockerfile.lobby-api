# --- Build stage ---
FROM node:20-slim AS build

RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

WORKDIR /app

# Copy workspace root manifests
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json tsconfig.base.json ./

# Copy all workspace package manifests (pnpm needs all for lockfile resolution)
COPY apps/lobby-api/package.json apps/lobby-api/
COPY apps/game-server/package.json apps/game-server/
COPY apps/admin-ui/package.json apps/admin-ui/
COPY packages/poker-engine/package.json packages/poker-engine/
COPY packages/hand-history/package.json packages/hand-history/
COPY packages/agent-sdk/package.json packages/agent-sdk/
COPY packages/database/package.json packages/database/
COPY packages/adapters-identity/package.json packages/adapters-identity/
COPY packages/adapters-ledger/package.json packages/adapters-ledger/
COPY packages/anti-collusion/package.json packages/anti-collusion/

# Install all dependencies
RUN pnpm install --frozen-lockfile

# Copy all source (pnpm workspace needs full tree for build)
COPY packages/ packages/
COPY apps/ apps/

# Build all workspace packages
RUN pnpm -r build

# Deploy minimal production install
RUN pnpm deploy --filter @agent-poker/lobby-api --prod /app/deploy

# --- Runtime stage ---
FROM node:20-slim AS runtime

RUN addgroup --system appgroup && adduser --system --ingroup appgroup appuser

WORKDIR /app

COPY --from=build /app/deploy/dist ./dist/
COPY --from=build /app/deploy/node_modules ./node_modules/
COPY --from=build /app/deploy/package.json ./

# Copy drizzle migration files and config (if they exist)
COPY --from=build /app/packages/database/drizzle* ./drizzle/
COPY --from=build /app/packages/database/drizzle.config.ts ./

# Copy entrypoint script
COPY docker/entrypoint-lobby-api.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

USER appuser

ENV NODE_ENV=production
EXPOSE 8080

ENTRYPOINT ["/entrypoint.sh"]
